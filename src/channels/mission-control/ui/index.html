<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MetaClaw Mission Control</title>
<link rel="stylesheet" href="/css/style.css">
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body x-data="app()" x-init="init()">
<div class="app">

  <!-- Icon Sidebar -->
  <div class="icon-sidebar">
    <div class="logo" @click="page='dashboard'" title="MetaClaw">‚ö°</div>

    <div class="sidebar-icon" :class="page==='dashboard' ? 'active' : ''" @click="navigate('dashboard')">
      üìä<span class="tooltip">Dashboard</span>
    </div>
    <div class="sidebar-icon" :class="page==='chat' ? 'active' : ''" @click="navigate('chat')">
      üí¨<span class="tooltip">Chat</span>
      <div class="badge-dot" x-show="false"></div>
    </div>
    <div class="sidebar-icon" :class="page==='health' ? 'active' : ''" @click="navigate('health')">
      ü©∫<span class="tooltip">Health</span>
    </div>
    <div class="sidebar-icon" :class="page==='settings' ? 'active' : ''" @click="navigate('settings')">
      ‚öôÔ∏è<span class="tooltip">Settings</span>
    </div>

    <div class="sidebar-spacer"></div>

    <div class="sidebar-icon" :style="'color:' + (connected ? 'var(--green)' : 'var(--red)')">
      <span x-text="connected ? '‚óè' : '‚óã'"></span>
      <span class="tooltip" x-text="connected ? 'Connected' : 'Disconnected'"></span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">

    <!-- ========== DASHBOARD ========== -->
    <template x-if="page==='dashboard'">
      <div class="dashboard-layout">
        <!-- Left: Instances -->
        <div class="panel-left">
          <div class="panel-header">
            <div class="panel-title">Instances</div>
            <div class="badge" x-text="instances.length">0</div>
          </div>
          <template x-for="(inst, i) in instances" :key="inst.id">
            <div class="agent-card" @click="page='chat'; selectInstance(inst.id)">
              <div class="agent-top">
                <div class="agent-avatar" :style="'background:' + avatarColors[i % avatarColors.length]" x-text="inst.emoji || inst.name[0]"></div>
                <div>
                  <div class="agent-name" x-text="inst.name"></div>
                  <div class="agent-role" x-text="inst.model?.split('/').pop() || ''"></div>
                </div>
              </div>
              <div class="agent-status">
                <div class="dot" :class="inst.status === 'running' ? 'dot-green' : 'dot-red'"></div>
                <span x-text="inst.status"></span>
              </div>
              <div class="agent-metrics">
                <div class="agent-metric">Requests: <span x-text="instanceStats[inst.id]?.requests || 0"></span></div>
                <div class="agent-metric">Tokens: <span x-text="formatNum(instanceStats[inst.id]?.outputTokens || 0)"></span></div>
              </div>
            </div>
          </template>
          <div class="add-instance">+ Add Instance</div>
          <div class="panel-header" style="margin-top:8px;"><div class="panel-title">System</div></div>
          <div style="padding:12px 16px;">
            <div class="config-row"><span class="config-key">WebSocket</span><span class="config-val" :style="'color:' + (connected ? 'var(--green)' : 'var(--red)')" x-text="connected ? '‚óè Connected' : '‚óè Offline'"></span></div>
            <div class="config-row"><span class="config-key">Instances</span><span class="config-val" x-text="instances.length + ' loaded'"></span></div>
            <div class="config-row"><span class="config-key">Doctor</span><span class="config-val" style="color:var(--green)">‚óè Active</span></div>
          </div>
        </div>

        <!-- Center: Dashboard -->
        <div class="panel-center">
          <div class="grid-2">
            <div class="card">
              <div class="card-title"><span class="icon">üìä</span> Token Usage (Today)</div>
              <template x-for="(inst, i) in instances" :key="inst.id">
                <div>
                  <div class="token-row"><span class="token-model" x-text="inst.name"></span><span class="token-value" x-text="formatNum((instanceStats[inst.id]?.inputTokens||0)+(instanceStats[inst.id]?.outputTokens||0))"></span></div>
                  <div class="token-bar"><div class="token-fill" :style="'width:' + Math.min(100, ((instanceStats[inst.id]?.inputTokens||0)+(instanceStats[inst.id]?.outputTokens||0))/50000*100) + '%;background:' + tokenColors[i % tokenColors.length]"></div></div>
                </div>
              </template>
            </div>
            <div class="card">
              <div class="card-title"><span class="icon">üí∞</span> Cost Summary</div>
              <div class="token-row" style="margin-bottom:8px;"><span class="token-model">Total Requests</span><span class="token-value" x-text="totalRequests"></span></div>
              <div class="token-row" style="margin-bottom:8px;"><span class="token-model">Total Input Tokens</span><span class="token-value" x-text="formatNum(totalInputTokens)"></span></div>
              <div class="token-row"><span class="token-model">Total Output Tokens</span><span class="token-value" x-text="formatNum(totalOutputTokens)"></span></div>
            </div>
          </div>
          <div class="card" style="margin-bottom:16px;">
            <div class="card-title"><span class="icon">üìã</span> Task Board</div>
            <div class="task-columns">
              <div class="task-col"><div class="task-col-header"><div class="dot dot-yellow" style="width:6px;height:6px;"></div> Queue <span class="task-col-count">0</span></div></div>
              <div class="task-col"><div class="task-col-header"><div class="dot dot-green" style="width:6px;height:6px;"></div> In Progress <span class="task-col-count">0</span></div></div>
              <div class="task-col"><div class="task-col-header">‚úì Done <span class="task-col-count">0</span></div></div>
            </div>
          </div>
          <div class="grid-2">
            <div class="card">
              <div class="card-title"><span class="icon">üí¨</span> Active Conversations</div>
              <div style="font-size:12px;color:var(--text2);">Click an instance to start chatting</div>
            </div>
            <div class="card">
              <div class="card-title"><span class="icon">üß†</span> Memory & Knowledge</div>
              <div class="knowledge-stat"><span>Instances</span><span class="kv" x-text="instances.length"></span></div>
            </div>
          </div>
        </div>

        <!-- Right: Live Feed -->
        <div class="panel-right">
          <div class="panel-header">
            <div class="panel-title">Live Feed</div>
            <div class="badge" style="background:var(--green);">Live</div>
          </div>
          <div class="tabs">
            <template x-for="tab in ['All','Tasks','Errors','Comms']" :key="tab">
              <div class="tab" :class="feedTab === tab ? 'active' : ''" @click="feedTab = tab" x-text="tab"></div>
            </template>
          </div>
          <div style="overflow-y:auto;">
            <template x-for="(evt, i) in feed" :key="i">
              <div class="feed-item">
                <div class="feed-top">
                  <div class="feed-dot" :style="'background:' + (evt.color || 'var(--accent)')" x-text="evt.initial"></div>
                  <div class="feed-agent" x-text="evt.agent"></div>
                  <div class="feed-time" x-text="evt.time"></div>
                </div>
                <div class="feed-text" x-text="evt.text"></div>
              </div>
            </template>
            <div x-show="feed.length === 0" style="padding:16px;color:var(--text2);font-size:12px;">Waiting for events...</div>
          </div>
        </div>
      </div>
    </template>

    <!-- ========== CHAT (WhatsApp/Telegram style) ========== -->
    <template x-if="page==='chat'">
      <div class="chat-layout">
        <!-- Chat List -->
        <div class="chat-list">
          <div class="chat-list-header">
            <h2>Chats</h2>
            <div class="badge" x-text="instances.length"></div>
          </div>
          <div class="chat-list-search">
            <input type="text" placeholder="Search instances..." x-model="chatSearch">
          </div>
          <div class="chat-list-items">
            <template x-for="(inst, i) in filteredInstances" :key="inst.id">
              <div class="chat-item" :class="chatInstanceId === inst.id ? 'active' : ''" @click="selectInstance(inst.id)">
                <div class="chat-avatar" :style="'background:' + avatarColors[i % avatarColors.length]" x-text="inst.emoji || inst.name[0]"></div>
                <div class="chat-item-info">
                  <div class="chat-item-name">
                    <span x-text="inst.name"></span>
                    <div class="dot" :class="inst.status === 'running' ? 'dot-green' : 'dot-red'" style="width:6px;height:6px;"></div>
                  </div>
                  <div class="chat-item-model" x-text="inst.model?.split('/').pop() || 'no model'"></div>
                  <div class="chat-item-preview" x-text="lastMessages[inst.id] || 'No messages yet'"></div>
                </div>
                <div class="chat-item-meta">
                  <div class="chat-item-time" x-text="lastTimes[inst.id] || ''"></div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Chat Area -->
        <template x-if="chatInstanceId">
          <div class="chat-area">
            <div class="chat-area-header">
              <div class="chat-avatar" :style="'background:' + avatarColors[instances.findIndex(i=>i.id===chatInstanceId) % avatarColors.length]" x-text="currentInstance?.emoji || 'ü§ñ'"></div>
              <div class="chat-area-info">
                <h3 x-text="currentInstance?.name || ''"></h3>
                <span x-text="(currentInstance?.model?.split('/').pop() || '') + ' ¬∑ ' + (currentInstance?.status || '')"></span>
              </div>
              <div class="chat-area-actions">
                <button @click="chatMessages = []" title="Clear chat">üóëÔ∏è</button>
              </div>
            </div>
            <div class="chat-messages" x-ref="chatScroll">
              <template x-for="msg in chatMessages" :key="msg.id">
                <div class="msg-bubble" :class="msg.role">
                  <div class="msg-content" x-html="renderMd(msg.text)"></div>
                  <div class="msg-meta">
                    <span x-text="msg.role === 'user' ? 'You' : currentInstance?.name"></span>
                    ¬∑ <span x-text="fmtTime(msg.timestamp)"></span>
                  </div>
                </div>
              </template>
              <div x-show="chatTyping" class="msg-bubble assistant">
                <div class="msg-content"><div class="typing-indicator"><span></span><span></span><span></span></div></div>
              </div>
            </div>
            <div class="chat-input-area">
              <form @submit.prevent="sendChat()">
                <input type="text" x-model="chatInput" placeholder="Type a message..." autofocus x-ref="chatInputEl">
                <button type="submit" class="send-btn" :disabled="!chatInput.trim()">‚û§</button>
              </form>
            </div>
          </div>
        </template>

        <!-- No chat selected -->
        <template x-if="!chatInstanceId">
          <div class="chat-empty">
            <div class="emoji">üí¨</div>
            <div class="text">Select an instance to start chatting</div>
          </div>
        </template>
      </div>
    </template>

    <!-- ========== HEALTH ========== -->
    <template x-if="page==='health'">
      <div style="padding:40px; width:100%; overflow-y:auto;">
        <h2 style="font-size:16px; margin-bottom:20px;">ü©∫ Health Monitor</h2>
        <div class="grid-2" style="max-width:900px;">
          <template x-for="inst in instances" :key="inst.id">
            <div class="card">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <span x-text="inst.emoji" style="font-size:20px;"></span>
                <span style="font-weight:600;" x-text="inst.name"></span>
                <div class="dot" :class="inst.status === 'running' ? 'dot-green' : 'dot-red'" style="margin-left:auto;"></div>
              </div>
              <div class="config-row"><span class="config-key">Status</span><span class="config-val" x-text="inst.status"></span></div>
              <div class="config-row"><span class="config-key">Model</span><span class="config-val" x-text="inst.model?.split('/').pop()"></span></div>
              <div class="config-row"><span class="config-key">Requests</span><span class="config-val" x-text="instanceStats[inst.id]?.requests || 0"></span></div>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- ========== SETTINGS ========== -->
    <template x-if="page==='settings'">
      <div style="padding:40px; width:100%; overflow-y:auto;">
        <h2 style="font-size:16px; margin-bottom:20px;">‚öôÔ∏è Settings</h2>
        <div class="card" style="max-width:600px;">
          <div class="card-title">Instances</div>
          <template x-for="inst in instances" :key="inst.id">
            <div class="config-row" style="padding:8px 0;">
              <span><span x-text="inst.emoji"></span> <span x-text="inst.name"></span></span>
              <span class="config-val" x-text="inst.model"></span>
            </div>
          </template>
        </div>
      </div>
    </template>

  </div>
</div>

<script>
function app() {
  return {
    page: (() => {
      const p = location.pathname;
      if (p.startsWith('/chat')) return 'chat';
      if (p.startsWith('/health')) return 'health';
      if (p.startsWith('/settings')) return 'settings';
      return 'dashboard';
    })(),
    connected: false, ws: null,
    instances: [], instanceStats: {},
    feed: [], feedTab: 'All',
    // Chat
    chatInstanceId: null, currentInstance: null,
    chatMessages: [], chatInput: '', chatTyping: false, chatSearch: '',
    lastMessages: {}, lastTimes: {},
    // Helpers
    avatarColors: [
      'linear-gradient(135deg, #a855f7, #6366f1)',
      'linear-gradient(135deg, #06b6d4, #3b82f6)',
      'linear-gradient(135deg, #f97316, #ef4444)',
      'linear-gradient(135deg, #22c55e, #06b6d4)',
    ],
    tokenColors: ['var(--accent)', 'var(--purple)', 'var(--cyan)', 'var(--green)'],

    get filteredInstances() {
      if (!this.chatSearch) return this.instances;
      const q = this.chatSearch.toLowerCase();
      return this.instances.filter(i => i.name.toLowerCase().includes(q) || i.id.includes(q));
    },
    get totalRequests() { return Object.values(this.instanceStats).reduce((a,s) => a + (s.requests||0), 0); },
    get totalInputTokens() { return Object.values(this.instanceStats).reduce((a,s) => a + (s.inputTokens||0), 0); },
    get totalOutputTokens() { return Object.values(this.instanceStats).reduce((a,s) => a + (s.outputTokens||0), 0); },

    init() {
      // Parse URL on load
      this._parseUrl();
      // Handle browser back/forward
      window.addEventListener('popstate', () => this._parseUrl());
      this.connectWs();
      this.pollStats();
      setInterval(() => this.pollStats(), 15000);
    },

    _parseUrl() {
      const p = location.pathname;
      const parts = p.split('/');
      if (parts[1] === 'chat') {
        this.page = 'chat';
        if (parts[2]) this.chatInstanceId = parts[2];
      } else if (parts[1] === 'health') {
        this.page = 'health';
      } else if (parts[1] === 'settings') {
        this.page = 'settings';
      } else {
        this.page = 'dashboard';
      }
    },

    connectWs() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.ws = new WebSocket(`${proto}//${location.host}/ws`);
      this.ws.onopen = () => {
        this.connected = true;
        if (this.chatInstanceId) this.ws.send(JSON.stringify({ type: 'join_chat', instanceId: this.chatInstanceId }));
      };
      this.ws.onclose = () => { this.connected = false; setTimeout(() => this.connectWs(), 3000); };
      this.ws.onmessage = (e) => this.handleMsg(JSON.parse(e.data));
    },

    handleMsg(msg) {
      if (msg.type === 'welcome') {
        this.instances = msg.instances || [];
        this.currentInstance = this.instances.find(i => i.id === this.chatInstanceId);
      } else if (msg.type === 'chat_history') {
        this.chatMessages = msg.messages || [];
        this.$nextTick(() => this.scrollChat());
      } else if (msg.type === 'chat_message') {
        this.chatMessages.push(msg.message);
        if (msg.message.role === 'assistant') this.chatTyping = false;
        // Update last message for chat list
        this.lastMessages[msg.message.instanceId] = msg.message.text?.slice(0, 50) || '';
        this.lastTimes[msg.message.instanceId] = this.fmtTime(msg.message.timestamp);
        this.$nextTick(() => this.scrollChat());
      } else if (msg.type === 'event') {
        const evt = msg.data || {};
        this.feed.unshift({
          agent: evt.id || evt.instanceId || 'System',
          initial: (evt.id || 'S')[0].toUpperCase(),
          text: msg.event + ': ' + (evt.name || evt.message || JSON.stringify(evt).slice(0,100)),
          time: this.fmtTime(Date.now()),
          color: msg.event?.includes('crash') ? 'var(--red)' : msg.event?.includes('spawn') ? 'var(--green)' : 'var(--accent)',
        });
        if (this.feed.length > 100) this.feed.pop();
        if (msg.event?.startsWith('instance.')) {
          fetch('/api/instances').then(r => r.json()).then(d => this.instances = d).catch(() => {});
        }
      }
    },

    navigate(pg) {
      this.page = pg;
      const url = pg === 'dashboard' ? '/' : pg === 'chat' && this.chatInstanceId ? '/chat/' + this.chatInstanceId : '/' + pg;
      history.pushState({}, '', url);
    },

    selectInstance(id) {
      if (this.chatInstanceId && this.chatInstanceId !== id) {
        this.ws?.send(JSON.stringify({ type: 'leave_chat' }));
      }
      this.chatInstanceId = id;
      this.currentInstance = this.instances.find(i => i.id === id);
      this.chatMessages = [];
      this.chatTyping = false;
      history.pushState({}, '', '/chat/' + id);
      this.ws?.send(JSON.stringify({ type: 'join_chat', instanceId: id }));
      this.$nextTick(() => this.$refs.chatInputEl?.focus());
    },

    sendChat() {
      const text = this.chatInput.trim();
      if (!text || !this.chatInstanceId) return;
      this.ws.send(JSON.stringify({ type: 'chat_message', instanceId: this.chatInstanceId, text }));
      this.chatInput = '';
      this.chatTyping = true;
    },

    async pollStats() {
      try {
        const res = await fetch('/api/stats');
        this.instanceStats = await res.json();
      } catch {}
    },

    renderMd(text) { try { return marked.parse(text || ''); } catch { return text; } },
    fmtTime(ts) { return new Date(ts).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }); },
    formatNum(n) { n=parseInt(n)||0; if(n>=1e6) return (n/1e6).toFixed(1)+'M'; if(n>=1e3) return (n/1e3).toFixed(0)+'K'; return String(n); },
    scrollChat() { const el = this.$refs.chatScroll; if (el) el.scrollTop = el.scrollHeight; },
  };
}
</script>
</body>
</html>
