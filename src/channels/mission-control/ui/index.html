<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MetaClaw Mission Control</title>
<link rel="stylesheet" href="/css/style.css">
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body x-data="app()" x-init="init()">
<div class="app">

  <!-- Icon Sidebar -->
  <div class="icon-sidebar">
    <div class="logo" @click="page='dashboard'" title="MetaClaw">‚ö°</div>

    <div class="sidebar-icon" :class="page==='dashboard' ? 'active' : ''" @click="navigate('dashboard')">
      üìä<span class="tooltip">Dashboard</span>
    </div>
    <div class="sidebar-icon" :class="page==='chat' ? 'active' : ''" @click="navigate('chat')">
      üí¨<span class="tooltip">Chat</span>
      <div class="badge-dot" x-show="false"></div>
    </div>
    <div class="sidebar-icon" :class="page==='health' ? 'active' : ''" @click="navigate('health')">
      ü©∫<span class="tooltip">Health</span>
    </div>
    <div class="sidebar-icon" :class="page==='settings' ? 'active' : ''" @click="navigate('settings')">
      ‚öôÔ∏è<span class="tooltip">Settings</span>
    </div>

    <div class="sidebar-spacer"></div>

    <div class="sidebar-icon" :style="'color:' + (connected ? 'var(--green)' : 'var(--red)')">
      <span x-text="connected ? '‚óè' : '‚óã'"></span>
      <span class="tooltip" x-text="connected ? 'Connected' : 'Disconnected'"></span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">

    <!-- ========== DASHBOARD ========== -->
    <template x-if="page==='dashboard'">
      <div class="dashboard-layout">
        <!-- Left: Instances -->
        <div class="panel-left">
          <div class="panel-header">
            <div class="panel-title">Instances</div>
            <div class="badge" x-text="$data.instances?.length || instances.length">0</div>
          </div>
          <template x-for="(inst, i) in instances" :key="inst.id">
            <div class="agent-card" @click="page='chat'; selectInstance(inst.id)">
              <div class="agent-top">
                <div class="agent-avatar" :style="'background:' + avatarColors[i % avatarColors.length]" x-text="inst.emoji || inst.name[0]"></div>
                <div style="flex:1;min-width:0;">
                  <div class="agent-name" x-text="inst.name"></div>
                  <div class="agent-role" x-text="inst.model?.split('/').pop() || ''"></div>
                </div>
                <div class="dot" :class="inst.status === 'running' ? 'dot-green' : 'dot-red'"></div>
              </div>
              <div style="display:flex;align-items:center;justify-content:space-between;">
                <div class="agent-metrics">
                  <div class="agent-metric">üì® <span x-text="instanceStats[inst.id]?.requests || 0"></span></div>
                  <div class="agent-metric">üí¨ <span x-text="instanceStats[inst.id]?.totalMessages || 0"></span></div>
                </div>
                <div class="instance-actions">
                  <button @click.stop="confirmRestart(inst)" class="action-btn restart-btn" title="Restart instance">üîÑ</button>
                  <button @click.stop="confirmDelete(inst)" class="action-btn del-btn" title="Delete instance">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          </template>

          <!-- System + Health combined -->
          <div class="panel-header" style="margin-top:4px;"><div class="panel-title">System</div></div>
          <div style="padding:12px 16px;">
            <div class="config-row">
              <span class="config-key">Status</span>
              <span class="config-val" :style="'color:' + (sysHealth.overall==='healthy'?'var(--green)':'var(--yellow)')" x-text="sysHealth.overall || 'loading...'"></span>
            </div>
            <div class="config-row"><span class="config-key">WebSocket</span><span class="config-val" :style="'color:' + (connected ? 'var(--green)' : 'var(--red)')" x-text="connected ? '‚óè Online' : '‚óè Offline'"></span></div>
            <div class="config-row"><span class="config-key">Memory</span><span class="config-val" x-text="(sysHealth.system?.memory?.pct || 0) + '%'"></span></div>
            <div class="config-row"><span class="config-key">CPU</span><span class="config-val" x-text="(sysHealth.system?.cpu?.usage || 0) + '%'"></span></div>
            <div class="config-row"><span class="config-key">Uptime</span><span class="config-val" x-text="fmtUptime(sysHealth.system?.appUptime || 0)"></span></div>
            <div class="config-row"><span class="config-key">Incidents</span><span class="config-val" :style="(sysHealth.incidents?.active||0) > 0 ? 'color:var(--red)' : ''" x-text="(sysHealth.incidents?.active||0) + ' active'"></span></div>
          </div>

          <!-- Health (channels + instances) -->
          <div class="panel-header"><div class="panel-title">Health</div></div>
          <div style="padding:8px 16px;">
            <template x-for="(health, id) in (sysHealth.channels || {})" :key="id">
              <div style="display:flex;align-items:center;gap:6px;padding:4px 0;font-size:11px;">
                <div class="dot" :class="health.status==='healthy' ? 'dot-green' : 'dot-red'" style="width:6px;height:6px;"></div>
                <span style="color:var(--text2);" x-text="id"></span>
              </div>
            </template>
            <template x-for="(health, id) in (sysHealth.instances || {})" :key="id">
              <div style="display:flex;align-items:center;gap:6px;padding:4px 0;font-size:11px;">
                <div class="dot" :class="health.status==='healthy' ? 'dot-green' : 'dot-red'" style="width:6px;height:6px;"></div>
                <span style="color:var(--text2);" x-text="id"></span>
              </div>
            </template>
          </div>

          <!-- Add Instance Button -->
          <div style="padding:8px 16px;">
            <button @click="showAddInstance = true" style="width:100%;padding:8px;background:var(--surface2);border:1px dashed var(--border);border-radius:8px;color:var(--text2);cursor:pointer;font-family:inherit;font-size:12px;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text2)'">+ Add Instance</button>
          </div>
        </div>

        <!-- Center: Dashboard -->
        <div class="panel-center">
          <!-- Quick Stats Row -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;">
            <div class="stat-card">
              <div class="stat-label">Total Requests</div>
              <div class="stat-value" x-text="totalRequests"></div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Input Tokens</div>
              <div class="stat-value" x-text="formatNum(totalInputTokens)"></div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Output Tokens</div>
              <div class="stat-value" x-text="formatNum(totalOutputTokens)"></div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Channels</div>
              <div class="stat-value" x-text="Object.keys(sysHealth.channels || {}).length"></div>
            </div>
          </div>

          <!-- Token Usage + Channels -->
          <div class="grid-2">
            <div class="card">
              <div class="card-title"><span class="icon">üìä</span> Token Usage</div>
              <template x-for="(inst, i) in instances" :key="inst.id">
                <div style="margin-bottom:10px;">
                  <div class="token-row"><span class="token-model" x-text="inst.emoji + ' ' + inst.name"></span><span class="token-value" x-text="formatNum((instanceStats[inst.id]?.inputTokens||0)+(instanceStats[inst.id]?.outputTokens||0))"></span></div>
                  <div class="token-bar"><div class="token-fill" :style="'width:' + Math.min(100, ((instanceStats[inst.id]?.inputTokens||0)+(instanceStats[inst.id]?.outputTokens||0))/50000*100) + '%;background:' + tokenColors[i % tokenColors.length]"></div></div>
                  <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text2);">
                    <span>In: <span x-text="formatNum(instanceStats[inst.id]?.inputTokens||0)"></span></span>
                    <span>Out: <span x-text="formatNum(instanceStats[inst.id]?.outputTokens||0)"></span></span>
                  </div>
                </div>
              </template>
            </div>
            <div class="card">
              <div class="card-title"><span class="icon">üì°</span> Channels</div>
              <template x-for="(health, id) in (sysHealth.channels || {})" :key="id">
                <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);">
                  <div class="dot" :class="health.status==='healthy' ? 'dot-green' : 'dot-red'"></div>
                  <span style="font-size:13px;font-weight:500;" x-text="id"></span>
                  <span style="margin-left:auto;font-size:11px;color:var(--text2);" x-text="health.message?.split(':').pop()?.trim() || health.status"></span>
                </div>
              </template>
              <div x-show="!sysHealth.channels || Object.keys(sysHealth.channels).length===0" style="font-size:12px;color:var(--text2);padding:8px 0;">Loading...</div>
            </div>
          </div>

          <!-- Quick Chat + Instance Details -->
          <div class="grid-2">
            <div class="card">
              <div class="card-title"><span class="icon">üí¨</span> Quick Chat</div>
              <template x-for="(inst, i) in instances" :key="inst.id">
                <div class="quick-chat-row" @click="page='chat'; selectInstance(inst.id)">
                  <div class="chat-avatar" style="width:32px;height:32px;font-size:14px;border-radius:8px;" :style="'background:' + avatarColors[i % avatarColors.length]" x-text="inst.emoji || inst.name[0]"></div>
                  <div style="flex:1;min-width:0;">
                    <div style="font-size:12px;font-weight:600;" x-text="inst.name"></div>
                    <div style="font-size:10px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" x-text="lastMessages[inst.id] || 'Start a conversation ‚Üí'"></div>
                  </div>
                  <span style="font-size:14px;color:var(--text2);">‚Üí</span>
                </div>
              </template>
            </div>
            <div class="card">
              <div class="card-title"><span class="icon">üì°</span> Channels</div>
              <template x-for="(health, id) in (sysHealth.channels || {})" :key="id">
                <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);">
                  <div class="dot" :class="health.status==='healthy' ? 'dot-green' : 'dot-red'"></div>
                  <div style="flex:1;min-width:0;">
                    <div style="font-size:12px;font-weight:600;" x-text="id"></div>
                    <div style="font-size:10px;color:var(--text2);" x-text="health.message || health.status"></div>
                  </div>
                  <span style="font-size:10px;padding:2px 8px;border-radius:4px;" :style="health.status==='healthy'?'background:rgba(34,197,94,0.1);color:var(--green)':'background:rgba(239,68,68,0.1);color:var(--red)'" x-text="health.status"></span>
                </div>
              </template>
              <div x-show="!sysHealth.channels || Object.keys(sysHealth.channels).length===0" style="font-size:11px;color:var(--text2);padding:8px 0;">Loading...</div>
            </div>
          </div>

          <!-- Task Board -->
          <div class="card">
            <div class="card-title"><span class="icon">üìã</span> Task Board</div>
            <div class="task-columns">
              <div class="task-col">
                <div class="task-col-header"><div class="dot dot-yellow" style="width:6px;height:6px;"></div> Queue <span class="task-col-count" x-text="tasks.filter(t=>t.status==='queue').length">0</span></div>
                <template x-for="task in tasks.filter(t=>t.status==='queue')" :key="task.id">
                  <div class="task-item">
                    <div class="task-priority" :class="'priority-'+task.priority" x-text="task.priority"></div>
                    <div class="task-item-title" x-text="task.title"></div>
                    <div class="task-item-agent" x-text="task.agent || ''"></div>
                  </div>
                </template>
                <div x-show="tasks.filter(t=>t.status==='queue').length===0" style="font-size:11px;color:var(--text2);padding:8px;text-align:center;">Empty</div>
              </div>
              <div class="task-col">
                <div class="task-col-header"><div class="dot dot-green" style="width:6px;height:6px;"></div> In Progress <span class="task-col-count" x-text="tasks.filter(t=>t.status==='active').length">0</span></div>
                <template x-for="task in tasks.filter(t=>t.status==='active')" :key="task.id">
                  <div class="task-item">
                    <div class="task-priority" :class="'priority-'+task.priority" x-text="task.priority"></div>
                    <div class="task-item-title" x-text="task.title"></div>
                    <div class="task-item-agent" x-text="task.agent || ''"></div>
                  </div>
                </template>
                <div x-show="tasks.filter(t=>t.status==='active').length===0" style="font-size:11px;color:var(--text2);padding:8px;text-align:center;">Empty</div>
              </div>
              <div class="task-col">
                <div class="task-col-header">‚úÖ Done <span class="task-col-count" x-text="tasks.filter(t=>t.status==='done').length">0</span></div>
                <template x-for="task in tasks.filter(t=>t.status==='done').slice(-5)" :key="task.id">
                  <div class="task-item" style="opacity:0.7;">
                    <div class="task-item-title" x-text="task.title"></div>
                    <div class="task-item-agent" x-text="task.agent || ''"></div>
                  </div>
                </template>
                <div x-show="tasks.filter(t=>t.status==='done').length===0" style="font-size:11px;color:var(--text2);padding:8px;text-align:center;">Empty</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Live Feed -->
        <div class="panel-right">
          <div class="panel-header">
            <div class="panel-title">Live Feed</div>
            <div class="badge" style="background:var(--green);">Live</div>
          </div>
          <div class="tabs">
            <template x-for="tab in ['All','System','Chat']" :key="tab">
              <div class="tab" :class="feedTab === tab ? 'active' : ''" @click="feedTab = tab" x-text="tab"></div>
            </template>
          </div>
          <div style="overflow-y:auto;flex:1;">
            <template x-for="(evt, i) in filteredFeed" :key="i">
              <div class="feed-item">
                <div class="feed-top">
                  <div class="feed-dot" :style="'background:' + (evt.color || 'var(--accent)')" x-text="evt.initial"></div>
                  <div class="feed-agent" x-text="evt.agent"></div>
                  <div class="feed-time" x-text="evt.time"></div>
                </div>
                <div class="feed-text" x-text="evt.text"></div>
              </div>
            </template>
            <div x-show="filteredFeed.length === 0" style="padding:20px 16px;color:var(--text2);font-size:12px;text-align:center;">
              <div style="font-size:24px;margin-bottom:8px;">üì°</div>
              Waiting for events...
            </div>
          </div>
        </div>
      </div>

    </template>

    <!-- ========== CHAT (WhatsApp/Telegram style) ========== -->
    <template x-if="page==='chat'">
      <div class="chat-layout">
        <!-- Chat List -->
        <div class="chat-list">
          <div class="chat-list-header">
            <h2>üí¨ Chats</h2>
            <div class="badge" x-text="instances.length"></div>
          </div>
          <div class="chat-list-search">
            <input type="text" placeholder="üîç Search..." x-model="chatSearch">
          </div>
          <div class="chat-list-items">
            <template x-for="(inst, i) in filteredInstances" :key="inst.id">
              <div class="chat-item" :class="chatInstanceId === inst.id ? 'active' : ''" @click="selectInstance(inst.id)">
                <div class="chat-avatar" :style="'background:' + avatarColors[i % avatarColors.length]" x-text="inst.emoji || inst.name[0]"></div>
                <div class="chat-item-info">
                  <div class="chat-item-name">
                    <span x-text="inst.name"></span>
                    <div class="dot" :class="inst.status === 'running' ? 'dot-green' : 'dot-red'" style="width:6px;height:6px;"></div>
                  </div>
                  <div class="chat-item-model" x-text="inst.model?.split('/').pop() || 'no model'"></div>
                  <div class="chat-item-preview" x-text="lastMessages[inst.id] || 'No messages yet'"></div>
                </div>
                <div class="chat-item-meta">
                  <div class="chat-item-time" x-text="lastTimes[inst.id] || ''"></div>
                  <div class="chat-item-status" x-show="instanceStats[inst.id]?.requests > 0">
                    <span style="font-size:9px;color:var(--text2);" x-text="(instanceStats[inst.id]?.requests||0) + ' msg'"></span>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Chat Area -->
        <template x-if="chatInstanceId">
          <div class="chat-area">
            <div class="chat-area-header">
              <div class="chat-avatar" :style="'background:' + avatarColors[instances.findIndex(i=>i.id===chatInstanceId) % avatarColors.length]" x-text="currentInstance?.emoji || 'ü§ñ'"></div>
              <div class="chat-area-info">
                <h3 x-text="currentInstance?.name || ''"></h3>
                <span>
                  <span x-text="currentInstance?.model?.split('/').pop() || ''"></span>
                  ¬∑ <span :style="currentInstance?.status==='running'?'color:var(--green)':'color:var(--red)'" x-text="currentInstance?.status || ''"></span>
                  <span x-show="instanceStats[chatInstanceId]?.requests > 0" style="color:var(--text2);">
                    ¬∑ <span x-text="(instanceStats[chatInstanceId]?.requests||0)"></span> requests
                    ¬∑ <span x-text="formatNum((instanceStats[chatInstanceId]?.inputTokens||0)+(instanceStats[chatInstanceId]?.outputTokens||0))"></span> tokens
                  </span>
                </span>
              </div>
              <div class="chat-area-actions">
                <button @click="clearChat()" title="Clear chat display">üóëÔ∏è</button>
              </div>
            </div>
            <div class="chat-messages" x-ref="chatScroll">
              <!-- Date separator for first message -->
              <div x-show="chatMessages.length > 0" class="chat-date-sep">
                <span x-text="new Date(chatMessages[0]?.timestamp || Date.now()).toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'})"></span>
              </div>
              <template x-for="(msg, idx) in chatMessages" :key="msg.id">
                <div>
                  <div class="msg-bubble" :class="msg.role">
                    <div class="msg-content" x-html="renderMd(msg.text)"></div>
                    <div class="msg-meta">
                      <span x-text="msg.role === 'user' ? 'You' : (currentInstance?.emoji||'ü§ñ') + ' ' + (currentInstance?.name||'')"></span>
                      ¬∑ <span x-text="fmtTime(msg.timestamp)"></span>
                    </div>
                  </div>
                </div>
              </template>
              <div x-show="chatTyping" class="msg-bubble assistant">
                <div class="msg-content"><div class="typing-indicator"><span></span><span></span><span></span></div></div>
              </div>
            </div>
            <div class="chat-input-area">
              <form @submit.prevent="sendChat()">
                <input type="text" x-model="chatInput" placeholder="Type a message..." autofocus x-ref="chatInputEl"
                  @keydown.escape="chatInput = ''">
                <button type="submit" class="send-btn" :disabled="!chatInput.trim() || chatTyping">
                  <span x-show="!chatTyping">‚û§</span>
                  <span x-show="chatTyping" class="typing-indicator" style="scale:0.6;">‚è≥</span>
                </button>
              </form>
            </div>
          </div>
        </template>

        <!-- No chat selected -->
        <template x-if="!chatInstanceId">
          <div class="chat-empty">
            <div class="emoji">üí¨</div>
            <div class="text" style="font-size:15px;font-weight:500;">Select an instance to start chatting</div>
            <div style="font-size:12px;color:var(--text2);margin-top:4px;">Choose from the list on the left</div>
          </div>
        </template>
      </div>
    </template>

    <!-- ========== HEALTH ========== -->
    <template x-if="page==='health'">
      <div style="padding:30px; width:100%; overflow-y:auto;" x-data="healthPage()" x-init="startPolling()">

        <!-- Overall Status Banner -->
        <div class="card" :style="`border-left:4px solid ${doctor.overall==='healthy'?'var(--green)':'var(--yellow)'};margin-bottom:20px;max-width:1100px;`">
          <div style="display:flex;align-items:center;gap:12px;">
            <span style="font-size:28px;" x-text="doctor.overall==='healthy' ? '‚úÖ' : '‚ö†Ô∏è'"></span>
            <div>
              <div style="font-size:16px;font-weight:600;" x-text="doctor.overall==='healthy' ? 'All Systems Healthy' : 'System Degraded'"></div>
              <div style="font-size:12px;color:var(--text-muted);">
                Uptime: <span x-text="formatUptime(doctor.system?.appUptime || 0)"></span>
                ¬∑ PID <span x-text="doctor.system?.pid || '?'"></span>
                ¬∑ <span x-text="doctor.system?.nodeVersion || ''"></span>
              </div>
            </div>
            <div style="margin-left:auto;font-size:11px;color:var(--text-muted);" x-text="'Updated ' + new Date(doctor.timestamp||0).toLocaleTimeString()"></div>
          </div>
        </div>

        <!-- System Metrics -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;max-width:1100px;margin-bottom:20px;">
          <div class="card">
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">üíæ Memory</div>
            <div style="font-size:20px;font-weight:700;" x-text="(doctor.system?.memory?.pct || 0) + '%'"></div>
            <div style="height:6px;background:var(--bg-tertiary);border-radius:3px;margin-top:6px;overflow:hidden;">
              <div :style="`height:100%;border-radius:3px;background:${doctor.system?.memory?.pct > 85 ? 'var(--red)' : 'var(--green)'};width:${doctor.system?.memory?.pct || 0}%`"></div>
            </div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px;" x-text="formatBytes(doctor.system?.memory?.used||0) + ' / ' + formatBytes(doctor.system?.memory?.total||0)"></div>
          </div>
          <div class="card">
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">‚ö° CPU</div>
            <div style="font-size:20px;font-weight:700;" x-text="(doctor.system?.cpu?.usage || 0) + '%'"></div>
            <div style="height:6px;background:var(--bg-tertiary);border-radius:3px;margin-top:6px;overflow:hidden;">
              <div :style="`height:100%;border-radius:3px;background:${doctor.system?.cpu?.usage > 80 ? 'var(--red)' : 'var(--accent)'};width:${doctor.system?.cpu?.usage || 0}%`"></div>
            </div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px;" x-text="doctor.system?.cpu?.cores + ' cores'"></div>
          </div>
          <div class="card">
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">üß† Heap</div>
            <div style="font-size:20px;font-weight:700;" x-text="formatBytes(doctor.system?.memoryUsage?.heapUsed || 0)"></div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px;" x-text="'of ' + formatBytes(doctor.system?.memoryUsage?.heapTotal || 0) + ' allocated'"></div>
          </div>
          <div class="card">
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">üî• Incidents</div>
            <div style="font-size:20px;font-weight:700;" :style="(doctor.incidents?.active||0) > 0 ? 'color:var(--red)' : 'color:var(--green)'" x-text="doctor.incidents?.active || 0"></div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px;" x-text="(doctor.incidents?.total||0) + ' total'"></div>
          </div>
        </div>

        <!-- Channels & Instances -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:1100px;margin-bottom:20px;">
          <!-- Channels -->
          <div class="card">
            <div class="card-title" style="margin-bottom:12px;">üì° Channels</div>
            <template x-for="(health, id) in (doctor.channels || {})" :key="id">
              <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);">
                <div class="dot" :class="health.status==='healthy' ? 'dot-green' : 'dot-red'"></div>
                <span style="font-size:13px;" x-text="id"></span>
                <span style="margin-left:auto;font-size:11px;color:var(--text-muted);" x-text="health.message"></span>
              </div>
            </template>
            <div x-show="!doctor.channels || Object.keys(doctor.channels).length===0" style="font-size:12px;color:var(--text-muted);">No channels</div>
          </div>

          <!-- Instances -->
          <div class="card">
            <div class="card-title" style="margin-bottom:12px;">ü§ñ Instances</div>
            <template x-for="(health, id) in (doctor.instances || {})" :key="id">
              <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);">
                <div class="dot" :class="health.status==='healthy' ? 'dot-green' : 'dot-red'"></div>
                <span style="font-size:13px;" x-text="id"></span>
                <span style="margin-left:auto;font-size:11px;color:var(--text-muted);" x-text="health.message"></span>
              </div>
            </template>
          </div>
        </div>

        <!-- Recovery State -->
        <div class="card" style="max-width:1100px;margin-bottom:20px;" x-show="doctor.recovery?.recentActions?.length > 0">
          <div class="card-title" style="margin-bottom:12px;">üîß Recovery Actions</div>
          <div style="max-height:200px;overflow-y:auto;">
            <template x-for="action in (doctor.recovery?.recentActions || []).slice().reverse()" :key="action.ts">
              <div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px;border-bottom:1px solid var(--border);">
                <span x-text="action.success ? '‚úÖ' : '‚ùå'"></span>
                <span style="color:var(--text-muted);" x-text="new Date(action.ts).toLocaleTimeString()"></span>
                <span x-text="action.key" style="font-family:monospace;"></span>
                <span x-show="action.error" style="color:var(--red);margin-left:auto;" x-text="action.error"></span>
              </div>
            </template>
          </div>
        </div>

        <!-- Incident Log -->
        <div class="card" style="max-width:1100px;">
          <div class="card-title" style="margin-bottom:12px;">üìã Recent Incidents</div>
          <div style="max-height:300px;overflow-y:auto;">
            <template x-for="inc in (doctor.incidents?.recent || []).slice().reverse()" :key="inc.id">
              <div style="display:flex;align-items:flex-start;gap:8px;padding:8px 0;font-size:12px;border-bottom:1px solid var(--border);">
                <span x-text="inc.resolved ? 'üü¢' : 'üî¥'" style="margin-top:1px;"></span>
                <div style="flex:1;">
                  <div style="display:flex;gap:8px;align-items:center;">
                    <span style="font-weight:600;" x-text="inc.type"></span>
                    <span style="color:var(--text-muted);font-family:monospace;" x-text="inc.module"></span>
                    <span style="margin-left:auto;color:var(--text-muted);" x-text="new Date(inc.timestamp).toLocaleTimeString()"></span>
                  </div>
                  <div style="color:var(--text-muted);margin-top:2px;" x-text="inc.description"></div>
                </div>
              </div>
            </template>
            <div x-show="!doctor.incidents?.recent?.length" style="font-size:12px;color:var(--text-muted);padding:12px 0;">No incidents recorded ‚ú®</div>
          </div>
        </div>

      </div>
    </template>

    <!-- ========== SETTINGS ========== -->
    <template x-if="page==='settings'">
      <div style="padding:30px; width:100%; overflow-y:auto;" x-data="settingsPage()" x-init="load()">

        <h2 style="font-size:16px; margin-bottom:20px;">‚öôÔ∏è Settings</h2>

        <!-- Global Config -->
        <div class="card" style="max-width:700px;margin-bottom:16px;">
          <div class="card-title">üåê Global Configuration</div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div>
              <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Default Model</label>
              <select x-model="globalConfig.model" class="modal-input">
                <option value="anthropic/claude-sonnet-4-6">Claude Sonnet 4.6</option>
                <option value="anthropic/claude-opus-4-6">Claude Opus 4.6</option>
                <option value="kimi/kimi-k2.5">Kimi K2.5</option>
                <option value="minimax/MiniMax-M2.5">MiniMax M2.5</option>
                <option value="openai/gpt-4o">GPT-4o</option>
              </select>
            </div>
            <div>
              <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Mission Control Port</label>
              <input x-model="globalConfig.port" type="number" class="modal-input" style="width:120px;">
            </div>
            <div style="display:flex;justify-content:flex-end;">
              <button @click="saveGlobal()" class="modal-btn-primary" :disabled="globalSaving" x-text="globalSaving ? 'Saving...' : 'Save Global Config'"></button>
            </div>
            <div x-show="globalMsg" style="font-size:12px;padding:6px 10px;border-radius:6px;" :style="globalMsg?.includes('Error') ? 'color:var(--red);background:rgba(239,68,68,0.1)' : 'color:var(--green);background:rgba(34,197,94,0.1)'" x-text="globalMsg"></div>
          </div>
        </div>

        <!-- WORKFLOW.md (read-only) -->
        <div class="card" style="max-width:700px;margin-bottom:16px;">
          <div class="card-title" style="display:flex;align-items:center;justify-content:space-between;">
            <span>üìã WORKFLOW.md <span style="font-size:9px;font-weight:normal;text-transform:none;letter-spacing:0;color:var(--text2);">(system rules ‚Äî read-only)</span></span>
            <span @click="showWorkflow = !showWorkflow" style="cursor:pointer;font-size:10px;color:var(--accent);text-transform:none;letter-spacing:0;" x-text="showWorkflow ? 'Hide ‚ñ≤' : 'Show ‚ñº'"></span>
          </div>
          <div x-show="showWorkflow" x-transition>
            <textarea x-model="workflowContent" rows="10" class="modal-input" style="resize:vertical;font-size:11px;line-height:1.5;font-family:'SF Mono','Fira Code',monospace;opacity:0.7;cursor:not-allowed;" readonly></textarea>
            <div style="font-size:10px;color:var(--text2);margin-top:4px;">üìç Location: <code>defaults/WORKFLOW.md</code> (project-level, edit via code only)</div>
          </div>
        </div>

        <!-- Instance Configs -->
        <div class="card" style="max-width:700px;margin-bottom:16px;">
          <div class="card-title">ü§ñ Instance Settings</div>

          <!-- Instance Tabs -->
          <div style="display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:16px;">
            <template x-for="inst in $data.instances || instances" :key="inst.id">
              <div class="tab" :class="selectedInst === inst.id ? 'active' : ''" @click="selectInst(inst.id)" style="display:flex;align-items:center;gap:6px;">
                <span x-text="inst.emoji"></span> <span x-text="inst.name"></span>
              </div>
            </template>
          </div>

          <!-- Instance Edit Form -->
          <template x-if="selectedInst && instConfig">
            <div style="display:flex;flex-direction:column;gap:12px;">
              <div style="display:grid;grid-template-columns:1fr 80px;gap:12px;">
                <div>
                  <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Name</label>
                  <input x-model="instConfig.name" type="text" class="modal-input">
                </div>
                <div>
                  <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Emoji</label>
                  <input x-model="instConfig.emoji" type="text" maxlength="4" class="modal-input" style="font-size:18px;text-align:center;">
                </div>
              </div>
              <div>
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Model</label>
                <select x-model="instConfig.model" class="modal-input">
                  <option value="anthropic/claude-sonnet-4-6">Claude Sonnet 4.6</option>
                  <option value="anthropic/claude-opus-4-6">Claude Opus 4.6</option>
                  <option value="kimi/kimi-k2.5">Kimi K2.5</option>
                  <option value="minimax/MiniMax-M2.5">MiniMax M2.5</option>
                  <option value="openai/gpt-4o">GPT-4o</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Personality</label>
                <textarea x-model="instConfig.personality" rows="3" class="modal-input" style="resize:vertical;" placeholder="Describe the instance's personality..."></textarea>
              </div>
              <div>
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Skills</label>
                <input x-model="instConfig.skillsStr" type="text" class="modal-input" placeholder="shell, web_search">
                <div style="font-size:10px;color:var(--text2);margin-top:2px;">Comma-separated skill names</div>
              </div>
              <!-- Channels -->
              <div>
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">üì° Channels</label>
                <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;">
                  <template x-for="ch in availableChannels" :key="ch.id">
                    <label style="display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:11px;transition:all 0.15s;" :style="instConfig.enabledChannels?.includes(ch.id) ? 'border-color:var(--accent);background:rgba(59,130,246,0.1)' : ''">
                      <input type="checkbox" :checked="instConfig.enabledChannels?.includes(ch.id)" @change="toggleChannel(ch.id)" style="accent-color:var(--accent);">
                      <span x-text="ch.icon + ' ' + ch.label"></span>
                    </label>
                  </template>
                </div>
                <div x-show="instConfig.hasTelegram" style="padding:8px 10px;background:var(--bg);border-radius:6px;border:1px solid var(--border);font-size:11px;">
                  <span style="color:var(--green);">‚óè</span> Telegram connected
                  <span style="color:var(--text2);margin-left:8px;">Whitelist: <span x-text="instConfig.telegramWhitelist?.join(', ') || 'none'"></span></span>
                </div>
              </div>

              <!-- SOUL.md -->
              <div>
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">üß¨ SOUL.md <span style="color:var(--text2);font-weight:normal;">(deep personality & identity)</span></label>
                <textarea x-model="instConfig.soul" rows="6" class="modal-input" style="resize:vertical;font-size:12px;line-height:1.6;" placeholder="Define the core personality, values, communication style...&#10;&#10;Example:&#10;You're warm and curious. You love explaining things simply.&#10;You speak casually but accurately."></textarea>
              </div>

              <!-- MY_RULES.md -->
              <div>
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">üìè MY_RULES.md <span style="color:var(--text2);font-weight:normal;">(behavioral rules & constraints)</span></label>
                <textarea x-model="instConfig.rules" rows="4" class="modal-input" style="resize:vertical;font-size:12px;line-height:1.6;" placeholder="Rules the instance must follow...&#10;&#10;Example:&#10;- Always respond in Bahasa Indonesia&#10;- Never share personal data&#10;- Keep responses under 200 words"></textarea>
              </div>

              <div style="display:flex;justify-content:flex-end;gap:8px;">
                <button @click="selectInst(selectedInst)" class="modal-btn-cancel">Reset</button>
                <button @click="saveInst()" class="modal-btn-primary" :disabled="instSaving" x-text="instSaving ? 'Saving...' : 'Save All'"></button>
              </div>
              <div x-show="instMsg" style="font-size:12px;padding:6px 10px;border-radius:6px;" :style="instMsg?.includes('Error') ? 'color:var(--red);background:rgba(239,68,68,0.1)' : 'color:var(--green);background:rgba(34,197,94,0.1)'" x-text="instMsg"></div>
            </div>
          </template>

          <div x-show="!selectedInst" style="font-size:12px;color:var(--text2);padding:12px 0;">Select an instance above to edit its settings</div>
        </div>

        <!-- Memory Card -->
        <template x-if="selectedInst && memoryData">
          <div class="card" style="max-width:700px;margin-bottom:16px;">
            <div class="card-title">üß† Memory</div>
            <div style="display:flex;flex-direction:column;gap:12px;">
              <div>
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">MEMORY.md <span style="font-weight:normal;">(long-term curated memory)</span></label>
                <textarea x-model="memoryData.longTerm" rows="6" class="modal-input" style="resize:vertical;font-size:12px;line-height:1.5;font-family:'SF Mono','Fira Code',monospace;" placeholder="Curated long-term memories..."></textarea>
              </div>
              <div>
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">üìÖ Daily Logs</label>
                <div style="display:flex;flex-wrap:wrap;gap:4px;">
                  <template x-for="f in memoryData.files?.filter(f => f.name.startsWith('memory/'))" :key="f.name">
                    <span style="font-size:10px;padding:3px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;" x-text="f.name.replace('memory/','').replace('.md','') + ' (' + Math.round(f.size/1024) + 'KB)'"></span>
                  </template>
                  <span x-show="!memoryData.files?.some(f => f.name.startsWith('memory/'))" style="font-size:11px;color:var(--text2);">No daily logs yet</span>
                </div>
              </div>
              <div style="display:flex;justify-content:flex-end;">
                <button @click="saveMemory()" class="modal-btn-primary" :disabled="memorySaving" x-text="memorySaving ? 'Saving...' : 'Save Memory'"></button>
              </div>
              <div x-show="memoryMsg" style="font-size:12px;padding:6px 10px;border-radius:6px;" :style="memoryMsg?.includes('Error') ? 'color:var(--red);background:rgba(239,68,68,0.1)' : 'color:var(--green);background:rgba(34,197,94,0.1)'" x-text="memoryMsg"></div>
            </div>
          </div>
        </template>

        <!-- Knowledge Card -->
        <template x-if="selectedInst && knowledgeData">
          <div class="card" style="max-width:700px;margin-bottom:16px;">
            <div class="card-title">üìö Knowledge <span style="font-size:10px;font-weight:normal;text-transform:none;letter-spacing:0;" x-text="'(' + (knowledgeData.facts?.length || 0) + ' facts)'"></span></div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <!-- Add fact -->
              <div style="display:flex;gap:8px;">
                <input x-model="newFact.tags" type="text" class="modal-input" style="width:140px;font-size:11px;" placeholder="tags (comma)">
                <input x-model="newFact.fact" type="text" class="modal-input" style="flex:1;font-size:11px;" placeholder="Fact..." @keydown.enter="addFact()">
                <button @click="addFact()" class="modal-btn-primary" style="padding:6px 12px;font-size:11px;">Add</button>
              </div>
              <!-- Facts list -->
              <div style="max-height:250px;overflow-y:auto;">
                <template x-for="(fact, idx) in knowledgeData.facts || []" :key="fact.id">
                  <div style="display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:11px;">
                    <div style="flex:1;min-width:0;">
                      <div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:2px;">
                        <template x-for="tag in fact.tags" :key="tag">
                          <span style="padding:1px 6px;background:rgba(59,130,246,0.15);color:var(--accent);border-radius:3px;font-size:10px;" x-text="tag"></span>
                        </template>
                      </div>
                      <div style="color:var(--text);" x-text="fact.fact"></div>
                    </div>
                    <button @click="removeFact(fact.id)" style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:11px;padding:2px;" title="Remove">‚úï</button>
                  </div>
                </template>
                <div x-show="!knowledgeData.facts?.length" style="font-size:11px;color:var(--text2);padding:12px 0;text-align:center;">No facts yet. AI will learn and add knowledge over time.</div>
              </div>
            </div>
          </div>
        </template>

      </div>
    </template>

  </div>
</div>

<!-- Add Instance Modal -->
<div x-show="showAddInstance" x-transition.opacity class="modal-overlay" @click.self="showAddInstance=false" @keydown.escape.window="showAddInstance=false">
  <div class="modal-card" @click.stop>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h3 style="font-size:15px;font-weight:600;">ü§ñ New Instance</h3>
      <button @click="showAddInstance=false" style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:18px;">‚úï</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <div>
        <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Name *</label>
        <input x-model="newInstance.name" type="text" placeholder="e.g. Luna" class="modal-input">
      </div>
      <div style="display:grid;grid-template-columns:1fr 80px;gap:12px;">
        <div>
          <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Model</label>
          <select x-model="newInstance.model" class="modal-input">
            <option value="anthropic/claude-sonnet-4-6">Claude Sonnet 4.6</option>
            <option value="anthropic/claude-opus-4-6">Claude Opus 4.6</option>
            <option value="kimi/kimi-k2.5">Kimi K2.5</option>
            <option value="minimax/MiniMax-M2.5">MiniMax M2.5</option>
            <option value="openai/gpt-4o">GPT-4o</option>
          </select>
        </div>
        <div>
          <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Emoji</label>
          <input x-model="newInstance.emoji" type="text" placeholder="ü§ñ" maxlength="4" class="modal-input" style="font-size:18px;text-align:center;">
        </div>
      </div>
      <div>
        <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Personality</label>
        <textarea x-model="newInstance.personality" placeholder="e.g. Friendly assistant who speaks Bahasa Indonesia" rows="3" class="modal-input" style="resize:vertical;"></textarea>
      </div>
      <div x-show="addInstanceError" style="font-size:12px;color:var(--red);padding:6px 10px;background:rgba(239,68,68,0.1);border-radius:6px;" x-text="addInstanceError"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:4px;">
        <button @click="showAddInstance=false" class="modal-btn-cancel">Cancel</button>
        <button @click="createInstance()" :disabled="!newInstance.name.trim() || addInstanceLoading" class="modal-btn-primary" :style="(!newInstance.name.trim()||addInstanceLoading)?'opacity:0.4;cursor:not-allowed':''">
          <span x-show="!addInstanceLoading">Create</span>
          <span x-show="addInstanceLoading">Creating...</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Restart Instance Modal -->
<div x-show="showRestartConfirm" x-transition.opacity class="modal-overlay" @click.self="showRestartConfirm=false" @keydown.escape.window="showRestartConfirm=false">
  <div class="modal-card" style="width:400px;" @click.stop>
    <div style="text-align:center;margin-bottom:16px;">
      <div style="font-size:40px;margin-bottom:8px;" x-text="restartTarget?.emoji || 'ü§ñ'"></div>
      <h3 style="font-size:15px;font-weight:600;">Restart <span x-text="restartTarget?.name || ''"></span>?</h3>
    </div>
    <p style="font-size:12px;color:var(--text2);text-align:center;margin-bottom:16px;line-height:1.6;">
      This will stop and restart the instance. Active conversations will be interrupted briefly.
    </p>
    <div x-show="restartError" style="font-size:12px;color:var(--red);padding:6px 10px;background:rgba(239,68,68,0.1);border-radius:6px;margin-bottom:12px;text-align:center;" x-text="restartError"></div>
    <div style="display:flex;gap:8px;justify-content:center;">
      <button @click="showRestartConfirm=false" class="modal-btn-cancel">Cancel</button>
      <button @click="restartInstance()" :disabled="restartLoading" class="modal-btn-primary" :style="restartLoading?'opacity:0.5;cursor:not-allowed':''">
        <span x-show="!restartLoading">Restart</span>
        <span x-show="restartLoading">Restarting...</span>
      </button>
    </div>
  </div>
</div>

<!-- Delete Instance Modal -->
<div x-show="showDeleteConfirm" x-transition.opacity class="modal-overlay" @click.self="showDeleteConfirm=false" @keydown.escape.window="showDeleteConfirm=false">
  <div class="modal-card" style="width:400px;" @click.stop>
    <div style="text-align:center;margin-bottom:16px;">
      <div style="font-size:40px;margin-bottom:8px;" x-text="deleteTarget?.emoji || 'ü§ñ'"></div>
      <h3 style="font-size:15px;font-weight:600;">Delete <span x-text="deleteTarget?.name || ''"></span>?</h3>
    </div>
    <p style="font-size:12px;color:var(--text2);text-align:center;margin-bottom:16px;line-height:1.6;">
      This will permanently delete the instance, config, memory, and chat history. This cannot be undone.
    </p>
    <div x-show="deleteError" style="font-size:12px;color:var(--red);padding:6px 10px;background:rgba(239,68,68,0.1);border-radius:6px;margin-bottom:12px;text-align:center;" x-text="deleteError"></div>
    <div style="display:flex;gap:8px;justify-content:center;">
      <button @click="showDeleteConfirm=false" class="modal-btn-cancel">Cancel</button>
      <button @click="deleteInstance()" :disabled="deleteLoading" class="modal-btn-danger" :style="deleteLoading?'opacity:0.5;cursor:not-allowed':''">
        <span x-show="!deleteLoading">Delete</span>
        <span x-show="deleteLoading">Deleting...</span>
      </button>
    </div>
  </div>
</div>

<script>
function dashboardPage() {
  return {};
}

function settingsPage() {
  return {
    globalConfig: { model: '', port: 3100 },
    globalSaving: false, globalMsg: '',
    selectedInst: null, instConfig: null,
    instSaving: false, instMsg: '',
    showWorkflow: false, workflowContent: '',
    memoryData: null, memorySaving: false, memoryMsg: '',
    knowledgeData: null, newFact: { tags: '', fact: '' },
    availableChannels: [
      { id: 'mission-control', label: 'Mission Control', icon: 'üåê' },
      { id: 'telegram', label: 'Telegram', icon: 'üì±' },
    ],

    async load() {
      try {
        const r = await fetch('/api/config');
        const d = await r.json();
        this.globalConfig.model = d.global?.model?.primary || 'anthropic/claude-sonnet-4-6';
        this.globalConfig.port = d.global?.missionControl?.port || 3100;
      } catch {}
      try {
        const wr = await fetch('/api/workflow');
        const wd = await wr.json();
        this.workflowContent = wd.content || '';
      } catch {}
      const insts = this.$data?.instances || this.instances;
      if (insts?.length > 0) this.selectInst(insts[0].id);
    },

    async selectInst(id) {
      this.selectedInst = id;
      this.instMsg = ''; this.memoryMsg = '';
      try {
        const [cfgRes, filesRes, memRes, knowRes] = await Promise.all([
          fetch(`/api/instances/${id}/config`),
          fetch(`/api/instances/${id}/files`),
          fetch(`/api/instances/${id}/memory`),
          fetch(`/api/instances/${id}/knowledge`),
        ]);
        this.memoryData = await memRes.json();
        this.knowledgeData = await knowRes.json();
        const d = await cfgRes.json();
        const f = await filesRes.json();
        const enabledChannels = [...(d.channels || [])];
        if (d.telegram) enabledChannels.push('telegram');
        // Dedupe
        const unique = [...new Set(enabledChannels.map(c => c.replace(/^telegram-.*/, 'telegram')))];
        this.instConfig = {
          name: d.identity?.name || id,
          emoji: d.identity?.emoji || 'ü§ñ',
          model: d.model?.primary || 'anthropic/claude-sonnet-4-6',
          personality: d.identity?.personality || '',
          skillsStr: (d.skills || []).join(', '),
          channels: d.channels || [],
          enabledChannels: unique,
          hasTelegram: !!d.telegram,
          telegramWhitelist: d.telegram?.whitelist || [],
          soul: f.soul || '',
          rules: f.rules || '',
        };
      } catch {}
    },

    toggleChannel(chId) {
      if (!this.instConfig.enabledChannels) this.instConfig.enabledChannels = [];
      const idx = this.instConfig.enabledChannels.indexOf(chId);
      if (idx >= 0) this.instConfig.enabledChannels.splice(idx, 1);
      else this.instConfig.enabledChannels.push(chId);
    },

    async saveGlobal() {
      this.globalSaving = true; this.globalMsg = '';
      try {
        const r = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: { primary: this.globalConfig.model },
            missionControl: { port: parseInt(this.globalConfig.port) },
          }),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error);
        this.globalMsg = '‚úÖ Saved! Restart needed for port change.';
      } catch (e) {
        this.globalMsg = 'Error: ' + e.message;
      } finally { this.globalSaving = false; }
    },

    async saveMemory() {
      if (!this.selectedInst || !this.memoryData) return;
      this.memorySaving = true; this.memoryMsg = '';
      try {
        const r = await fetch(`/api/instances/${this.selectedInst}/memory`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ longTerm: this.memoryData.longTerm }),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error);
        this.memoryMsg = '‚úÖ Memory saved!';
      } catch (e) { this.memoryMsg = 'Error: ' + e.message; }
      finally { this.memorySaving = false; }
    },

    async addFact() {
      if (!this.newFact.fact.trim() || !this.selectedInst) return;
      const tags = this.newFact.tags.split(',').map(s => s.trim()).filter(Boolean);
      if (!tags.length) tags.push('general');
      try {
        const r = await fetch(`/api/instances/${this.selectedInst}/knowledge`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'add', tags, fact: this.newFact.fact }),
        });
        await r.json();
        this.newFact = { tags: '', fact: '' };
        // Refresh
        const kr = await fetch(`/api/instances/${this.selectedInst}/knowledge`);
        this.knowledgeData = await kr.json();
      } catch {}
    },

    async removeFact(id) {
      if (!this.selectedInst) return;
      try {
        await fetch(`/api/instances/${this.selectedInst}/knowledge`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'remove', id }),
        });
        const kr = await fetch(`/api/instances/${this.selectedInst}/knowledge`);
        this.knowledgeData = await kr.json();
      } catch {}
    },

    async saveInst() {
      if (!this.selectedInst || !this.instConfig) return;
      this.instSaving = true; this.instMsg = '';
      try {
        const skills = this.instConfig.skillsStr.split(',').map(s => s.trim()).filter(Boolean);
        const headers = { 'Content-Type': 'application/json' };

        // Save config + identity
        const r1 = await fetch(`/api/instances/${this.selectedInst}/config`, {
          method: 'POST', headers,
          body: JSON.stringify({
            model: { primary: this.instConfig.model },
            identity: { name: this.instConfig.name, emoji: this.instConfig.emoji, personality: this.instConfig.personality },
            skills,
          }),
        });
        const d1 = await r1.json();
        if (!r1.ok) throw new Error(d1.error);

        // Save SOUL.md + MY_RULES.md
        const r2 = await fetch(`/api/instances/${this.selectedInst}/files`, {
          method: 'POST', headers,
          body: JSON.stringify({ soul: this.instConfig.soul, rules: this.instConfig.rules }),
        });
        const d2 = await r2.json();
        if (!r2.ok) throw new Error(d2.error);

        // Save channels
        const channels = this.instConfig.enabledChannels.filter(c => c !== 'telegram');
        const hasTg = this.instConfig.enabledChannels.includes('telegram');
        const r3 = await fetch(`/api/instances/${this.selectedInst}/channels`, {
          method: 'POST', headers,
          body: JSON.stringify({ channels, telegram: hasTg ? { enabled: true } : false }),
        });
        const d3 = await r3.json();
        if (!r3.ok) throw new Error(d3.error);

        // Update parent
        if (d1.instances) {
          const app = Alpine.closestDataStack(this.$el)?.[0];
          if (app?.instances) app.instances = d1.instances;
        }
        this.instMsg = '‚úÖ All saved! Restart instance to apply changes.';
      } catch (e) {
        this.instMsg = 'Error: ' + e.message;
      } finally { this.instSaving = false; }
    },
  };
}

function healthPage() {
  return {
    doctor: {},
    _timer: null,
    async fetchDoctor() {
      try {
        const r = await fetch('/api/doctor');
        this.doctor = await r.json();
      } catch {}
    },
    startPolling() {
      this.fetchDoctor();
      this._timer = setInterval(() => this.fetchDoctor(), 5000);
    },
    destroy() {
      if (this._timer) clearInterval(this._timer);
    },
    formatUptime(s) {
      if (s < 60) return s + 's';
      if (s < 3600) return Math.floor(s/60) + 'm ' + (s%60) + 's';
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      if (h < 24) return h + 'h ' + m + 'm';
      return Math.floor(h/24) + 'd ' + (h%24) + 'h';
    },
    formatBytes(b) {
      if (b < 1024) return b + ' B';
      if (b < 1048576) return (b/1024).toFixed(0) + ' KB';
      if (b < 1073741824) return (b/1048576).toFixed(1) + ' MB';
      return (b/1073741824).toFixed(1) + ' GB';
    },
  };
}

function app() {
  return {
    page: (() => {
      const p = location.pathname;
      if (p.startsWith('/chat')) return 'chat';
      if (p.startsWith('/health')) return 'health';
      if (p.startsWith('/settings')) return 'settings';
      return 'dashboard';
    })(),
    connected: false, ws: null,
    instances: [], instanceStats: {},
    feed: [], feedTab: 'All', tasks: [], sysHealth: {},
    // Add Instance
    showAddInstance: false, addInstanceLoading: false, addInstanceError: '',
    newInstance: { name: '', emoji: 'ü§ñ', model: 'anthropic/claude-sonnet-4-6', personality: '' },
    // Delete Instance
    showDeleteConfirm: false, deleteTarget: null, deleteLoading: false, deleteError: '',
    // Restart Instance
    showRestartConfirm: false, restartTarget: null, restartLoading: false, restartError: '',
    // Chat
    chatInstanceId: null, currentInstance: null,
    chatMessages: [], chatInput: '', chatTyping: false, chatSearch: '',
    lastMessages: {}, lastTimes: {},
    // Helpers
    avatarColors: [
      'linear-gradient(135deg, #a855f7, #6366f1)',
      'linear-gradient(135deg, #06b6d4, #3b82f6)',
      'linear-gradient(135deg, #f97316, #ef4444)',
      'linear-gradient(135deg, #22c55e, #06b6d4)',
    ],
    tokenColors: ['var(--accent)', 'var(--purple)', 'var(--cyan)', 'var(--green)'],

    get filteredInstances() {
      if (!this.chatSearch) return this.instances;
      const q = this.chatSearch.toLowerCase();
      return this.instances.filter(i => i.name.toLowerCase().includes(q) || i.id.includes(q));
    },
    get filteredFeed() {
      if (this.feedTab === 'All') return this.feed;
      if (this.feedTab === 'System') return this.feed.filter(e => e.category === 'system');
      if (this.feedTab === 'Chat') return this.feed.filter(e => e.category === 'chat');
      return this.feed;
    },
    get totalRequests() { return Object.values(this.instanceStats).reduce((a,s) => a + (s.requests||0), 0); },
    get totalInputTokens() { return Object.values(this.instanceStats).reduce((a,s) => a + (s.inputTokens||0), 0); },
    get totalOutputTokens() { return Object.values(this.instanceStats).reduce((a,s) => a + (s.outputTokens||0), 0); },

    init() {
      // Parse URL on load
      this._parseUrl();
      // Handle browser back/forward
      window.addEventListener('popstate', () => this._parseUrl());
      this.connectWs();
      this.pollStats();
      this.pollHealth();
      setInterval(() => this.pollStats(), 15000);
      setInterval(() => this.pollHealth(), 10000);
    },

    _parseUrl() {
      const p = location.pathname;
      const parts = p.split('/');
      if (parts[1] === 'chat') {
        this.page = 'chat';
        if (parts[2]) this.chatInstanceId = parts[2];
      } else if (parts[1] === 'health') {
        this.page = 'health';
      } else if (parts[1] === 'settings') {
        this.page = 'settings';
      } else {
        this.page = 'dashboard';
      }
    },

    connectWs() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.ws = new WebSocket(`${proto}//${location.host}/ws`);
      this.ws.onopen = () => {
        this.connected = true;
        if (this.chatInstanceId) this.ws.send(JSON.stringify({ type: 'join_chat', instanceId: this.chatInstanceId }));
      };
      this.ws.onclose = () => { this.connected = false; setTimeout(() => this.connectWs(), 3000); };
      this.ws.onmessage = (e) => this.handleMsg(JSON.parse(e.data));
    },

    handleMsg(msg) {
      if (msg.type === 'welcome') {
        this.instances = msg.instances || [];
        this.currentInstance = this.instances.find(i => i.id === this.chatInstanceId);
        // Fetch last message previews for all instances
        for (const inst of this.instances) {
          fetch(`/api/chat/${inst.id}/history`).then(r => r.json()).then(msgs => {
            if (msgs?.length > 0) {
              const last = msgs[msgs.length - 1];
              this.lastMessages = { ...this.lastMessages, [inst.id]: last.text?.slice(0, 50) || '' };
              this.lastTimes = { ...this.lastTimes, [inst.id]: this.fmtTime(last.timestamp) };
            }
          }).catch(() => {});
        }
      } else if (msg.type === 'chat_history') {
        this.chatMessages = msg.messages || [];
        // Update sidebar preview from history
        if (msg.messages?.length > 0) {
          const last = msg.messages[msg.messages.length - 1];
          this.lastMessages = { ...this.lastMessages, [msg.instanceId]: last.text?.slice(0, 50) || '' };
          this.lastTimes = { ...this.lastTimes, [msg.instanceId]: this.fmtTime(last.timestamp) };
        }
        this.$nextTick(() => this.scrollChat());
      } else if (msg.type === 'chat_message') {
        this.chatMessages.push(msg.message);
        if (msg.message.role === 'assistant') this.chatTyping = false;
        // Update last message for chat list
        this.lastMessages = { ...this.lastMessages, [msg.message.instanceId]: msg.message.text?.slice(0, 50) || '' };
        this.lastTimes = { ...this.lastTimes, [msg.message.instanceId]: this.fmtTime(msg.message.timestamp) };
        this.$nextTick(() => this.scrollChat());
      } else if (msg.type === 'event') {
        const evt = msg.data || {};
        const feedItem = this._formatFeedEvent(msg.event, evt);
        if (feedItem) {
          // Dedupe: skip if same text within 2 seconds
          const isDupe = this.feed.length > 0 && this.feed[0].text === feedItem.text &&
            this.feed[0].agent === feedItem.agent;
          if (!isDupe) {
            this.feed.unshift(feedItem);
            if (this.feed.length > 100) this.feed.pop();
          }
        }
        if (msg.event?.startsWith('instance.')) {
          fetch('/api/instances').then(r => r.json()).then(d => this.instances = d).catch(() => {});
        }
      }
    },

    navigate(pg) {
      this.page = pg;
      const url = pg === 'dashboard' ? '/' : pg === 'chat' && this.chatInstanceId ? '/chat/' + this.chatInstanceId : '/' + pg;
      history.pushState({}, '', url);
    },

    selectInstance(id) {
      if (this.chatInstanceId && this.chatInstanceId !== id) {
        this.ws?.send(JSON.stringify({ type: 'leave_chat' }));
      }
      this.chatInstanceId = id;
      this.currentInstance = this.instances.find(i => i.id === id);
      this.chatMessages = [];
      this.chatTyping = false;
      history.pushState({}, '', '/chat/' + id);
      this.ws?.send(JSON.stringify({ type: 'join_chat', instanceId: id }));
      this.$nextTick(() => this.$refs.chatInputEl?.focus());
    },

    sendChat() {
      const text = this.chatInput.trim();
      if (!text || !this.chatInstanceId || this.chatTyping) return;
      this.ws.send(JSON.stringify({ type: 'chat_message', instanceId: this.chatInstanceId, text }));
      this.chatInput = '';
      this.chatTyping = true;
    },

    confirmRestart(inst) {
      this.restartTarget = inst;
      this.restartError = '';
      this.showRestartConfirm = true;
    },

    async restartInstance() {
      if (!this.restartTarget) return;
      this.restartLoading = true;
      this.restartError = '';
      try {
        const res = await fetch(`/api/instances/${this.restartTarget.id}/restart`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        this.instances = data.instances || this.instances;
        this.showRestartConfirm = false;
        this.restartTarget = null;
      } catch (e) {
        this.restartError = e.message;
      } finally {
        this.restartLoading = false;
      }
    },

    confirmDelete(inst) {
      this.deleteTarget = inst;
      this.deleteError = '';
      this.showDeleteConfirm = true;
    },

    async deleteInstance() {
      if (!this.deleteTarget) return;
      this.deleteLoading = true;
      this.deleteError = '';
      try {
        const res = await fetch(`/api/instances/${this.deleteTarget.id}`, { method: 'DELETE' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        this.instances = data.instances || this.instances.filter(i => i.id !== this.deleteTarget.id);
        if (this.chatInstanceId === this.deleteTarget.id) {
          this.chatInstanceId = null;
          this.currentInstance = null;
          this.chatMessages = [];
        }
        this.showDeleteConfirm = false;
        this.deleteTarget = null;
      } catch (e) {
        this.deleteError = e.message;
      } finally {
        this.deleteLoading = false;
      }
    },

    async createInstance() {
      const name = this.newInstance.name.trim();
      if (!name) return;
      this.addInstanceLoading = true;
      this.addInstanceError = '';
      try {
        const res = await fetch('/api/instances', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            emoji: this.newInstance.emoji || 'ü§ñ',
            model: this.newInstance.model,
            personality: this.newInstance.personality,
          }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        this.instances = data.instances || this.instances;
        this.showAddInstance = false;
        this.newInstance = { name: '', emoji: 'ü§ñ', model: 'anthropic/claude-sonnet-4-6', personality: '' };
        // Broadcast updated instance list via WS
        this.ws?.send(JSON.stringify({ type: 'refresh_instances' }));
      } catch (e) {
        this.addInstanceError = e.message;
      } finally {
        this.addInstanceLoading = false;
      }
    },

    clearChat() {
      if (confirm('Clear chat display? (History is preserved in database)')) {
        this.chatMessages = [];
      }
    },

    async pollHealth() {
      try {
        const r = await fetch('/api/doctor');
        this.sysHealth = await r.json();
      } catch {}
    },

    fmtUptime(s) {
      if (!s) return '0s';
      if (s < 60) return s + 's';
      if (s < 3600) return Math.floor(s/60) + 'm ' + (s%60) + 's';
      const h = Math.floor(s/3600);
      if (h < 24) return h + 'h ' + Math.floor((s%3600)/60) + 'm';
      return Math.floor(h/24) + 'd ' + (h%24) + 'h';
    },

    async pollStats() {
      try {
        const res = await fetch('/api/stats');
        this.instanceStats = await res.json();
      } catch {}
    },

    _formatFeedEvent(event, data) {
      const time = this.fmtTime(Date.now());
      const map = {
        'health.check': () => {
          // Only show unhealthy checks, skip routine healthy ones
          const results = data.results || {};
          const unhealthy = Object.entries(results).filter(([, h]) => h.status !== 'healthy');
          if (unhealthy.length === 0) return null;
          const statuses = unhealthy.map(([id, h]) => `‚ùå ${id}`).join(', ');
          return { agent: 'Doctor', initial: 'ü©∫', text: `Issue detected: ${statuses}`, time, color: 'var(--yellow)', category: 'system' };
        },
        'health.incident': () => ({
          agent: 'Doctor', initial: 'üö®', text: `Incident: ${data.description || data.type}`, time, color: 'var(--red)', category: 'system'
        }),
        'doctor.incident': () => ({
          agent: 'Doctor', initial: 'üö®', text: `${data.type}: ${data.description || ''}`, time, color: 'var(--red)', category: 'system'
        }),
        'doctor.resolved': () => ({
          agent: 'Doctor', initial: '‚úÖ', text: `Resolved: ${data.type} (${data.module})`, time, color: 'var(--green)', category: 'system'
        }),
        'instance.spawn': () => ({
          agent: data.name || data.id, initial: data.emoji || 'ü§ñ', text: `Instance started`, time, color: 'var(--green)', category: 'system'
        }),
        'instance.stop': () => ({
          agent: data.name || data.id, initial: '‚èπ', text: `Instance stopped`, time, color: 'var(--yellow)', category: 'system'
        }),
        'instance.crash': () => ({
          agent: data.name || data.id, initial: 'üí•', text: `Instance crashed: ${data.error || ''}`, time, color: 'var(--red)', category: 'system'
        }),
        'message.in': () => ({
          agent: data.senderId || 'User', initial: 'üí¨', text: `Message in ${data.channelId}: "${(data.text||'').slice(0,60)}"`, time, color: 'var(--accent)', category: 'chat'
        }),
        'message.out': () => ({
          agent: data.channelId || 'Channel', initial: 'üì§', text: `Reply sent to ${data.chatId}`, time, color: 'var(--purple)', category: 'chat'
        }),
        'instance.response': () => ({
          agent: data.instanceId || '?', initial: 'ü§ñ', text: `Responded (${data.model?.split('/').pop() || '?'})`, time, color: 'var(--accent)', category: 'chat'
        }),
      };
      const fn = map[event];
      if (fn) return fn();
      // Skip unknown events
      if (!event) return null;
      return { agent: 'System', initial: 'S', text: `${event}`, time, color: 'var(--text2)', category: 'system' };
    },

    renderMd(text) { try { return marked.parse(text || ''); } catch { return text; } },
    fmtTime(ts) { return new Date(ts).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }); },
    formatNum(n) { n=parseInt(n)||0; if(n>=1e6) return (n/1e6).toFixed(1)+'M'; if(n>=1e3) return (n/1e3).toFixed(0)+'K'; return String(n); },
    scrollChat() { const el = this.$refs.chatScroll; if (el) el.scrollTop = el.scrollHeight; },
  };
}
</script>
</body>
</html>
