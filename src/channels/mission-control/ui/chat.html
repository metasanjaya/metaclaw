<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MetaClaw Chat</title>
<link rel="stylesheet" href="/css/style.css">
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body x-data="chatApp()" x-init="init()">

<!-- Top Bar -->
<div class="topbar">
  <div class="topbar-left">
    <div class="logo">‚ö° METACLAW <span>MISSION CONTROL</span></div>
    <div class="status-pill" :class="connected ? 'status-online' : 'status-offline'" x-text="connected ? '‚óè Online' : '‚óè Offline'"></div>
  </div>
  <div class="topbar-stats">
    <div class="topbar-stat">
      <div class="value" x-text="currentInstance?.emoji || 'ü§ñ'" style="font-size:28px;"></div>
      <div class="label" x-text="currentInstance?.name || 'Select'"></div>
    </div>
  </div>
  <div class="topbar-right">
    <div><div class="clock" x-text="clock">00:00:00</div><div class="clock-date" x-text="clockDate">---</div></div>
  </div>
</div>

<!-- Nav -->
<div class="nav">
  <a href="/">Dashboard</a>
  <a href="/chat" class="active">Chat</a>
  <a href="/health">Health</a>
  <a href="/settings">Settings</a>
</div>

<!-- Chat Layout -->
<div class="chat-layout">

  <!-- Instance Switcher -->
  <div class="chat-header">
    <a href="/" style="color:var(--text2);text-decoration:none;font-size:12px;">‚Üê Back</a>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <template x-for="inst in instances" :key="inst.id">
        <button class="instance-pill" :class="inst.id === instanceId ? 'active' : ''" @click="switchInstance(inst.id)" x-text="inst.emoji + ' ' + inst.name"></button>
      </template>
    </div>
    <div style="margin-left:auto;font-size:10px;color:var(--text2);">
      <span x-text="messages.length + ' messages'"></span>
      <span x-show="currentInstance" x-text="' ¬∑ ' + (currentInstance?.status || '')"></span>
    </div>
  </div>

  <!-- Messages -->
  <div class="chat-messages" x-ref="chatScroll">
    <template x-for="msg in messages" :key="msg.id">
      <div class="msg-bubble" :class="msg.role">
        <div class="msg-content" x-html="renderMd(msg.text)"></div>
        <div class="msg-meta">
          <span x-text="msg.role === 'user' ? 'You' : (currentInstance?.name || 'Assistant')"></span>
          ¬∑ <span x-text="new Date(msg.timestamp).toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'})"></span>
        </div>
      </div>
    </template>

    <!-- Typing -->
    <div x-show="typing" class="msg-bubble assistant">
      <div class="msg-content">
        <div class="typing-indicator"><span></span><span></span><span></span></div>
      </div>
    </div>

    <div x-show="messages.length === 0 && !typing" style="text-align:center;padding:60px 20px;color:var(--text2);">
      <div style="font-size:48px;margin-bottom:12px;" x-text="currentInstance?.emoji || 'ü§ñ'"></div>
      <div style="font-size:14px;" x-text="currentInstance ? 'Start chatting with ' + currentInstance.name : 'Select an instance to chat'"></div>
    </div>
  </div>

  <!-- Input -->
  <div class="chat-input-area">
    <form @submit.prevent="send()">
      <input type="text" x-model="input" placeholder="Type a message..." :disabled="!instanceId" autofocus>
      <button type="submit" :disabled="!input.trim() || !instanceId">Send</button>
    </form>
  </div>
</div>

<script>
function chatApp() {
  return {
    ws: null, connected: false,
    instances: [], instanceId: null, currentInstance: null,
    messages: [], input: '', typing: false,
    clock: '', clockDate: '',

    init() {
      const parts = location.pathname.split('/');
      if (parts.length >= 3 && parts[2]) this.instanceId = parts[2];
      this.updateClock();
      setInterval(() => this.updateClock(), 1000);
      this.connectWs();
    },

    updateClock() {
      const now = new Date();
      this.clock = now.toLocaleTimeString('en-US', { hour12: false });
      const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
      const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
      this.clockDate = `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()} ${now.getFullYear()}`;
    },

    connectWs() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.ws = new WebSocket(`${proto}//${location.host}/ws`);
      this.ws.onopen = () => {
        this.connected = true;
        if (this.instanceId) this.ws.send(JSON.stringify({ type: 'join_chat', instanceId: this.instanceId }));
      };
      this.ws.onclose = () => { this.connected = false; setTimeout(() => this.connectWs(), 3000); };
      this.ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'welcome') {
          this.instances = msg.instances || [];
          this.currentInstance = this.instances.find(i => i.id === this.instanceId);
          if (!this.instanceId && this.instances.length > 0) this.switchInstance(this.instances[0].id);
        } else if (msg.type === 'chat_history') {
          this.messages = msg.messages || [];
          this.$nextTick(() => this.scrollDown());
        } else if (msg.type === 'chat_message') {
          this.messages.push(msg.message);
          if (msg.message.role === 'assistant') this.typing = false;
          this.$nextTick(() => this.scrollDown());
        }
      };
    },

    switchInstance(id) {
      if (this.instanceId) this.ws?.send(JSON.stringify({ type: 'leave_chat' }));
      this.instanceId = id;
      this.currentInstance = this.instances.find(i => i.id === id);
      this.messages = [];
      history.replaceState(null, '', '/chat/' + id);
      this.ws?.send(JSON.stringify({ type: 'join_chat', instanceId: id }));
    },

    send() {
      const text = this.input.trim();
      if (!text || !this.instanceId) return;
      this.ws.send(JSON.stringify({ type: 'chat_message', instanceId: this.instanceId, text }));
      this.input = '';
      this.typing = true;
    },

    renderMd(text) {
      try { return marked.parse(text || ''); } catch { return text; }
    },

    scrollDown() {
      const el = this.$refs.chatScroll;
      if (el) el.scrollTop = el.scrollHeight;
    },
  };
}
</script>
</body>
</html>
